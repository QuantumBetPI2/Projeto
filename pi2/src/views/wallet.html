<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Minha Carteira</title>
    <link rel="stylesheet" href="styleWallet.css">
</head>
<body>
    <div class="wallet-container">
        <h1 class="wallet-title">Minha Carteira</h1>
        <p class="wallet-balance">Saldo atual: <span id="currentBalance">R$ 0.00</span></p>
        <div class="wallet-buttons">
            <button class="wallet-button" onclick="addCreditsModal()">Adicionar Créditos</button>
            <button class="wallet-button withdraw" onclick="withdrawModal()">Sacar Saldo</button>
        </div>
    </div>

    <div id="addCreditsModal" class="modal">
        <div class="modal-content">
            <h2>Adicionar Créditos</h2>
            <input type="number" id="creditAmount" placeholder="Valor em R$" class="modal-input">
            <div class="modal-actions">
                <button class="modal-button" onclick="confirmAddCredits()">Confirmar</button>
                <button class="modal-button close" onclick="closeModal()">Cancelar</button>
            </div>
        </div>
    </div>

    <div id="withdrawModal" class="modal">
        <div class="modal-content">
            <h2>Sacar Saldo</h2>
            <input type="number" id="withdrawAmount" placeholder="Valor em R$" class="modal-input">
            <input type="text" id="bankDetails" placeholder="Detalhes Bancários" class="modal-input">
            <div class="modal-actions">
                <button class="modal-button" onclick="confirmWithdraw()">Confirmar</button>
                <button class="modal-button close" onclick="closeModal()">Cancelar</button>
            </div>
        </div>
    </div>

    <script>
        function addCreditsModal() {
            document.getElementById('addCreditsModal').style.display = 'flex';
        }

        function withdrawModal() {
            document.getElementById('withdrawModal').style.display = 'flex';
        }

        function closeModal() {
            document.getElementById('addCreditsModal').style.display = 'none';
            document.getElementById('withdrawModal').style.display = 'none';
        }

        async function confirmAddCredits() {
            const amount = document.getElementById('creditAmount').value;
            if (amount <= 0) {
                alert("Valor inválido.");
                return;
            }
            
            try {
                const response = await fetch('http://localhost:3000/addFunds', {
                    method: 'POST',
                    headers: {
                        'Authorization': `Bearer ${localStorage.getItem('token')}`,
                        'Content-Type': 'application/json'
                    },
                    body: JSON.stringify({ amount })
                });

                const data = await response.json();

                if (response.status === 201) {
                    alert('Créditos adicionados com sucesso!');
                    loadBalance();
                } else {
                    alert(`Erro: ${data.message}`);
                }
            } catch (error) {
                console.error("Erro ao adicionar créditos:", error);
                alert("Erro ao adicionar créditos.");
            }
        }

        async function confirmWithdraw() {
            const amount = document.getElementById('withdrawAmount').value;
            const bankDetails = document.getElementById('bankDetails').value;

            if (amount <= 0 || !bankDetails) {
                alert("Preencha os campos corretamente.");
                return;
            }

            try {
                const response = await fetch('http://localhost:3000/withdrawFunds', {
                    method: 'POST',
                    headers: {
                        'Authorization': `Bearer ${localStorage.getItem('token')}`,
                        'Content-Type': 'application/json'
                    },
                    body: JSON.stringify({ amount, bankDetails })
                });

                const data = await response.json();

                if (response.status === 200) {
                    alert('Saque realizado com sucesso!');
                    loadBalance();
                } else {
                    alert(`Erro: ${data.message}`);
                }
            } catch (error) {
                console.error("Erro ao realizar saque:", error);
                alert("Erro ao realizar saque.");
            }
        }

        async function loadBalance() {
            try {
                const response = await fetch('http://localhost:3000/getBalance', {
                    headers: {
                        'Authorization': `Bearer ${localStorage.getItem('token')}`
                    }
                });

                const data = await response.json();
                document.getElementById('currentBalance').textContent = `R$ ${data.balance.toFixed(2)}`;
            } catch (error) {
                console.error("Erro ao carregar saldo:", error);
                alert("Erro ao carregar saldo.");
            }
        }

        // Carregar o saldo ao iniciar a página
        loadBalance();
    </script>
</body>
</html>
